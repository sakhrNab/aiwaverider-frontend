import{B as I,g as Ge,r as d,A as J,aA as V,t as me,b0 as ge,b1 as be,y as P,j as a,o as Fe,p as We,b2 as Je,b3 as Ve,b4 as $e,b5 as ye,L as qe,C as Qe,D as Ke,aD as Ze,b6 as et,b7 as tt,b8 as nt,b9 as rt}from"./index-CDuOHj3I.js";import{p as G}from"./purify.es-DxJI3Wx7.js";import{E as at,S as st,T as it,a as He,C as ot,b as xe,c as ct,I as lt,d as ut,Y as dt,M as mt,L as ft}from"./MenuBar-Np-EM3wI.js";const U=43200,pe=1440,ve=Symbol.for("constructDateFrom");function fe(e,t){return typeof e=="function"?e(t):e&&typeof e=="object"&&ve in e?e[ve](t):e instanceof Date?new e.constructor(t):new Date(t)}function $(e,t){return fe(e,e)}let ht={};function gt(){return ht}function we(e){const t=$(e),r=new Date(Date.UTC(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds(),t.getMilliseconds()));return r.setUTCFullYear(t.getFullYear()),+e-+r}function he(e,...t){const r=fe.bind(null,e||t.find(s=>typeof s=="object"));return t.map(r)}function Y(e,t){const r=+$(e)-+$(t);return r<0?-1:r>0?1:r}function bt(e){return fe(e,Date.now())}function yt(e,t,r){const[s,n]=he(r?.in,e,t),c=s.getFullYear()-n.getFullYear(),l=s.getMonth()-n.getMonth();return c*12+l}function xt(e){return t=>{const s=(e?Math[e]:Math.trunc)(t);return s===0?0:s}}function pt(e,t){return+$(e)-+$(t)}function vt(e,t){const r=$(e);return r.setHours(23,59,59,999),r}function wt(e,t){const r=$(e),s=r.getMonth();return r.setFullYear(r.getFullYear(),s+1,0),r.setHours(23,59,59,999),r}function kt(e,t){const r=$(e);return+vt(r)==+wt(r)}function jt(e,t,r){const[s,n,c]=he(r?.in,e,e,t),l=Y(n,c),o=Math.abs(yt(n,c));if(o<1)return 0;n.getMonth()===1&&n.getDate()>27&&n.setDate(30),n.setMonth(n.getMonth()-l*o);let m=Y(n,c)===-l;kt(s)&&o===1&&Y(s,c)===1&&(m=!1);const i=l*(o-+m);return i===0?0:i}function Tt(e,t,r){const s=pt(e,t)/1e3;return xt(r?.roundingMethod)(s)}const Ct={lessThanXSeconds:{one:"less than a second",other:"less than {{count}} seconds"},xSeconds:{one:"1 second",other:"{{count}} seconds"},halfAMinute:"half a minute",lessThanXMinutes:{one:"less than a minute",other:"less than {{count}} minutes"},xMinutes:{one:"1 minute",other:"{{count}} minutes"},aboutXHours:{one:"about 1 hour",other:"about {{count}} hours"},xHours:{one:"1 hour",other:"{{count}} hours"},xDays:{one:"1 day",other:"{{count}} days"},aboutXWeeks:{one:"about 1 week",other:"about {{count}} weeks"},xWeeks:{one:"1 week",other:"{{count}} weeks"},aboutXMonths:{one:"about 1 month",other:"about {{count}} months"},xMonths:{one:"1 month",other:"{{count}} months"},aboutXYears:{one:"about 1 year",other:"about {{count}} years"},xYears:{one:"1 year",other:"{{count}} years"},overXYears:{one:"over 1 year",other:"over {{count}} years"},almostXYears:{one:"almost 1 year",other:"almost {{count}} years"}},St=(e,t,r)=>{let s;const n=Ct[e];return typeof n=="string"?s=n:t===1?s=n.one:s=n.other.replace("{{count}}",t.toString()),r?.addSuffix?r.comparison&&r.comparison>0?"in "+s:s+" ago":s};function Q(e){return(t={})=>{const r=t.width?String(t.width):e.defaultWidth;return e.formats[r]||e.formats[e.defaultWidth]}}const Mt={full:"EEEE, MMMM do, y",long:"MMMM do, y",medium:"MMM d, y",short:"MM/dd/yyyy"},Dt={full:"h:mm:ss a zzzz",long:"h:mm:ss a z",medium:"h:mm:ss a",short:"h:mm a"},Nt={full:"{{date}} 'at' {{time}}",long:"{{date}} 'at' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},Pt={date:Q({formats:Mt,defaultWidth:"full"}),time:Q({formats:Dt,defaultWidth:"full"}),dateTime:Q({formats:Nt,defaultWidth:"full"})},At={lastWeek:"'last' eeee 'at' p",yesterday:"'yesterday at' p",today:"'today at' p",tomorrow:"'tomorrow at' p",nextWeek:"eeee 'at' p",other:"P"},Lt=(e,t,r,s)=>At[e];function B(e){return(t,r)=>{const s=r?.context?String(r.context):"standalone";let n;if(s==="formatting"&&e.formattingValues){const l=e.defaultFormattingWidth||e.defaultWidth,o=r?.width?String(r.width):l;n=e.formattingValues[o]||e.formattingValues[l]}else{const l=e.defaultWidth,o=r?.width?String(r.width):e.defaultWidth;n=e.values[o]||e.values[l]}const c=e.argumentCallback?e.argumentCallback(t):t;return n[c]}}const _t={narrow:["B","A"],abbreviated:["BC","AD"],wide:["Before Christ","Anno Domini"]},Et={narrow:["1","2","3","4"],abbreviated:["Q1","Q2","Q3","Q4"],wide:["1st quarter","2nd quarter","3rd quarter","4th quarter"]},Rt={narrow:["J","F","M","A","M","J","J","A","S","O","N","D"],abbreviated:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],wide:["January","February","March","April","May","June","July","August","September","October","November","December"]},Ot={narrow:["S","M","T","W","T","F","S"],short:["Su","Mo","Tu","We","Th","Fr","Sa"],abbreviated:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],wide:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"]},Ft={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"morning",afternoon:"afternoon",evening:"evening",night:"night"}},Wt={narrow:{am:"a",pm:"p",midnight:"mi",noon:"n",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},abbreviated:{am:"AM",pm:"PM",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"},wide:{am:"a.m.",pm:"p.m.",midnight:"midnight",noon:"noon",morning:"in the morning",afternoon:"in the afternoon",evening:"in the evening",night:"at night"}},$t=(e,t)=>{const r=Number(e),s=r%100;if(s>20||s<10)switch(s%10){case 1:return r+"st";case 2:return r+"nd";case 3:return r+"rd"}return r+"th"},qt={ordinalNumber:$t,era:B({values:_t,defaultWidth:"wide"}),quarter:B({values:Et,defaultWidth:"wide",argumentCallback:e=>e-1}),month:B({values:Rt,defaultWidth:"wide"}),day:B({values:Ot,defaultWidth:"wide"}),dayPeriod:B({values:Ft,defaultWidth:"wide",formattingValues:Wt,defaultFormattingWidth:"wide"})};function X(e){return(t,r={})=>{const s=r.width,n=s&&e.matchPatterns[s]||e.matchPatterns[e.defaultMatchWidth],c=t.match(n);if(!c)return null;const l=c[0],o=s&&e.parsePatterns[s]||e.parsePatterns[e.defaultParseWidth],m=Array.isArray(o)?zt(o,v=>v.test(l)):Ht(o,v=>v.test(l));let i;i=e.valueCallback?e.valueCallback(m):m,i=r.valueCallback?r.valueCallback(i):i;const h=t.slice(l.length);return{value:i,rest:h}}}function Ht(e,t){for(const r in e)if(Object.prototype.hasOwnProperty.call(e,r)&&t(e[r]))return r}function zt(e,t){for(let r=0;r<e.length;r++)if(t(e[r]))return r}function Bt(e){return(t,r={})=>{const s=t.match(e.matchPattern);if(!s)return null;const n=s[0],c=t.match(e.parsePattern);if(!c)return null;let l=e.valueCallback?e.valueCallback(c[0]):c[0];l=r.valueCallback?r.valueCallback(l):l;const o=t.slice(n.length);return{value:l,rest:o}}}const Xt=/^(\d+)(th|st|nd|rd)?/i,It=/\d+/i,Ut={narrow:/^(b|a)/i,abbreviated:/^(b\.?\s?c\.?|b\.?\s?c\.?\s?e\.?|a\.?\s?d\.?|c\.?\s?e\.?)/i,wide:/^(before christ|before common era|anno domini|common era)/i},Yt={any:[/^b/i,/^(a|c)/i]},Gt={narrow:/^[1234]/i,abbreviated:/^q[1234]/i,wide:/^[1234](th|st|nd|rd)? quarter/i},Jt={any:[/1/i,/2/i,/3/i,/4/i]},Vt={narrow:/^[jfmasond]/i,abbreviated:/^(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec)/i,wide:/^(january|february|march|april|may|june|july|august|september|october|november|december)/i},Qt={narrow:[/^j/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^ja/i,/^f/i,/^mar/i,/^ap/i,/^may/i,/^jun/i,/^jul/i,/^au/i,/^s/i,/^o/i,/^n/i,/^d/i]},Kt={narrow:/^[smtwf]/i,short:/^(su|mo|tu|we|th|fr|sa)/i,abbreviated:/^(sun|mon|tue|wed|thu|fri|sat)/i,wide:/^(sunday|monday|tuesday|wednesday|thursday|friday|saturday)/i},Zt={narrow:[/^s/i,/^m/i,/^t/i,/^w/i,/^t/i,/^f/i,/^s/i],any:[/^su/i,/^m/i,/^tu/i,/^w/i,/^th/i,/^f/i,/^sa/i]},en={narrow:/^(a|p|mi|n|(in the|at) (morning|afternoon|evening|night))/i,any:/^([ap]\.?\s?m\.?|midnight|noon|(in the|at) (morning|afternoon|evening|night))/i},tn={any:{am:/^a/i,pm:/^p/i,midnight:/^mi/i,noon:/^no/i,morning:/morning/i,afternoon:/afternoon/i,evening:/evening/i,night:/night/i}},nn={ordinalNumber:Bt({matchPattern:Xt,parsePattern:It,valueCallback:e=>parseInt(e,10)}),era:X({matchPatterns:Ut,defaultMatchWidth:"wide",parsePatterns:Yt,defaultParseWidth:"any"}),quarter:X({matchPatterns:Gt,defaultMatchWidth:"wide",parsePatterns:Jt,defaultParseWidth:"any",valueCallback:e=>e+1}),month:X({matchPatterns:Vt,defaultMatchWidth:"wide",parsePatterns:Qt,defaultParseWidth:"any"}),day:X({matchPatterns:Kt,defaultMatchWidth:"wide",parsePatterns:Zt,defaultParseWidth:"any"}),dayPeriod:X({matchPatterns:en,defaultMatchWidth:"any",parsePatterns:tn,defaultParseWidth:"any"})},rn={code:"en-US",formatDistance:St,formatLong:Pt,formatRelative:Lt,localize:qt,match:nn,options:{weekStartsOn:0,firstWeekContainsDate:1}};function an(e,t,r){const s=gt(),n=r?.locale??s.locale??rn,c=2520,l=Y(e,t);if(isNaN(l))throw new RangeError("Invalid time value");const o=Object.assign({},r,{addSuffix:r?.addSuffix,comparison:l}),[m,i]=he(r?.in,...l>0?[t,e]:[e,t]),h=Tt(i,m),v=(we(i)-we(m))/1e3,x=Math.round((h-v)/60);let j;if(x<2)return r?.includeSeconds?h<5?n.formatDistance("lessThanXSeconds",5,o):h<10?n.formatDistance("lessThanXSeconds",10,o):h<20?n.formatDistance("lessThanXSeconds",20,o):h<40?n.formatDistance("halfAMinute",0,o):h<60?n.formatDistance("lessThanXMinutes",1,o):n.formatDistance("xMinutes",1,o):x===0?n.formatDistance("lessThanXMinutes",1,o):n.formatDistance("xMinutes",x,o);if(x<45)return n.formatDistance("xMinutes",x,o);if(x<90)return n.formatDistance("aboutXHours",1,o);if(x<pe){const g=Math.round(x/60);return n.formatDistance("aboutXHours",g,o)}else{if(x<c)return n.formatDistance("xDays",1,o);if(x<U){const g=Math.round(x/pe);return n.formatDistance("xDays",g,o)}else if(x<U*2)return j=Math.round(x/U),n.formatDistance("aboutXMonths",j,o)}if(j=jt(i,m),j<12){const g=Math.round(x/U);return n.formatDistance("xMonths",g,o)}else{const g=j%12,k=Math.trunc(j/12);return g<3?n.formatDistance("aboutXYears",k,o):g<9?n.formatDistance("overXYears",k,o):n.formatDistance("almostXYears",k+1,o)}}function ke(e,t){return an(e,bt(e),t)}var K,je;function ze(){if(je)return K;je=1;function e(t){var r=typeof t;return t!=null&&(r=="object"||r=="function")}return K=e,K}var Z,Te;function sn(){if(Te)return Z;Te=1;var e=typeof I=="object"&&I&&I.Object===Object&&I;return Z=e,Z}var ee,Ce;function Be(){if(Ce)return ee;Ce=1;var e=sn(),t=typeof self=="object"&&self&&self.Object===Object&&self,r=e||t||Function("return this")();return ee=r,ee}var te,Se;function on(){if(Se)return te;Se=1;var e=Be(),t=function(){return e.Date.now()};return te=t,te}var ne,Me;function cn(){if(Me)return ne;Me=1;var e=/\s/;function t(r){for(var s=r.length;s--&&e.test(r.charAt(s)););return s}return ne=t,ne}var re,De;function ln(){if(De)return re;De=1;var e=cn(),t=/^\s+/;function r(s){return s&&s.slice(0,e(s)+1).replace(t,"")}return re=r,re}var ae,Ne;function Xe(){if(Ne)return ae;Ne=1;var e=Be(),t=e.Symbol;return ae=t,ae}var se,Pe;function un(){if(Pe)return se;Pe=1;var e=Xe(),t=Object.prototype,r=t.hasOwnProperty,s=t.toString,n=e?e.toStringTag:void 0;function c(l){var o=r.call(l,n),m=l[n];try{l[n]=void 0;var i=!0}catch{}var h=s.call(l);return i&&(o?l[n]=m:delete l[n]),h}return se=c,se}var ie,Ae;function dn(){if(Ae)return ie;Ae=1;var e=Object.prototype,t=e.toString;function r(s){return t.call(s)}return ie=r,ie}var oe,Le;function mn(){if(Le)return oe;Le=1;var e=Xe(),t=un(),r=dn(),s="[object Null]",n="[object Undefined]",c=e?e.toStringTag:void 0;function l(o){return o==null?o===void 0?n:s:c&&c in Object(o)?t(o):r(o)}return oe=l,oe}var ce,_e;function fn(){if(_e)return ce;_e=1;function e(t){return t!=null&&typeof t=="object"}return ce=e,ce}var le,Ee;function hn(){if(Ee)return le;Ee=1;var e=mn(),t=fn(),r="[object Symbol]";function s(n){return typeof n=="symbol"||t(n)&&e(n)==r}return le=s,le}var ue,Re;function gn(){if(Re)return ue;Re=1;var e=ln(),t=ze(),r=hn(),s=NaN,n=/^[-+]0x[0-9a-f]+$/i,c=/^0b[01]+$/i,l=/^0o[0-7]+$/i,o=parseInt;function m(i){if(typeof i=="number")return i;if(r(i))return s;if(t(i)){var h=typeof i.valueOf=="function"?i.valueOf():i;i=t(h)?h+"":h}if(typeof i!="string")return i===0?i:+i;i=e(i);var v=c.test(i);return v||l.test(i)?o(i.slice(2),v?2:8):n.test(i)?s:+i}return ue=m,ue}var de,Oe;function bn(){if(Oe)return de;Oe=1;var e=ze(),t=on(),r=gn(),s="Expected a function",n=Math.max,c=Math.min;function l(o,m,i){var h,v,x,j,g,k,M=0,_=!1,b=!1,T=!0;if(typeof o!="function")throw new TypeError(s);m=r(m)||0,e(i)&&(_=!!i.leading,b="maxWait"in i,x=b?n(r(i.maxWait)||0,m):x,T="trailing"in i?!!i.trailing:T);function w(y){var C=h,F=v;return h=v=void 0,M=y,j=o.apply(F,C),j}function L(y){return M=y,g=setTimeout(N,m),_?w(y):j}function E(y){var C=y-k,F=y-M,H=m-C;return b?c(H,x-F):H}function A(y){var C=y-k,F=y-M;return k===void 0||C>=m||C<0||b&&F>=x}function N(){var y=t();if(A(y))return W(y);g=setTimeout(N,E(y))}function W(y){return g=void 0,T&&h?w(y):(h=v=void 0,j)}function D(){g!==void 0&&clearTimeout(g),M=0,h=k=v=g=void 0}function R(){return g===void 0?j:W(t())}function O(){var y=t(),C=A(y);if(h=arguments,v=this,k=y,C){if(g===void 0)return L(k);if(b)return clearTimeout(g),g=setTimeout(N,m),w(k)}return g===void 0&&(g=setTimeout(N,m)),j}return O.cancel=D,O.flush=R,O}return de=l,de}var yn=bn();const Ie=Ge(yn),xn=({postId:e,comments:t,onAuthRequired:r,refreshComments:s})=>{const{user:n}=d.useContext(J),{updateCommentInCache:c,addCommentToCache:l,removeCommentFromCache:o}=d.useContext(V),{darkMode:m}=me(),[i,h]=d.useState(new Set),[v,x]=d.useState(4),[j,g]=d.useState(null),[k,M]=d.useState(""),[_,b]=d.useState(null),[T,w]=d.useState(""),[L,E]=d.useState(""),A=d.useCallback(Ie(async(f,p,u)=>{if(!f||!e){console.error("[CommentsList] Invalid commentId or postId in debouncedLikeAction",{commentId:f,postId:e}),h(S=>{const q=new Set(S);return f&&q.delete(f),q});return}try{const S=p?await ge(e,f):await be(e,f);S&&S.updatedComment?c(e,S.updatedComment):(console.error("[CommentsList] Invalid response from like/unlike action",S),u(),P.error("Failed to update like. Please try again."))}catch(S){console.error(`[CommentsList] Error ${p?"unliking":"liking"} comment ${f}:`,S),u(),P.error("Failed to update like. Please try again.")}finally{h(S=>{const q=new Set(S);return q.delete(f),q})}},300),[e,ge,be,c]),N=async f=>{if(!f||!f.id||!n||!n.uid){console.warn("Invalid comment like attempt",{comment:f,user:n});return}if(i.has(f.id))return;const p=Array.isArray(f.likes)?f.likes:[],u=p.includes(n.uid),S=[...p],q=()=>{const z={...f,likes:u?p.filter(Ye=>Ye!==n.uid):[...p,n.uid]};c(e,z)},Ue=()=>{const z={...f,likes:S};c(e,z)};h(z=>new Set([...z,f.id])),q(),A(f.id,u,Ue)},W=async f=>{if(!n){P.info(a.jsxs("div",{children:["Please ",a.jsx("a",{href:"/signin",className:"text-blue-500 hover:text-blue-700",children:"sign in"})," or"," ",a.jsx("a",{href:"/signup",className:"text-blue-500 hover:text-blue-700",children:"sign up"})," to reply to comments."]}),{position:"top-center",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0});return}if(k.trim())try{const p=await $e(e,{commentText:k.trim(),parentCommentId:f});p&&(l(e,p),g(null),M(""))}catch(p){console.error("Error adding reply",p),P.error("Failed to add reply. Please try again.")}},D=async f=>{if(!n){P.info("Please sign in to delete comments.");return}try{await Ve(e,f),o(e,f)}catch(p){console.error("Error deleting comment:",p),P.error("Failed to delete comment. Please try again.")}},R=async f=>{if(!n){P.info("Please sign in to edit comments.");return}if(T.trim())try{const p=await Je(e,f,{commentText:T.trim()});p&&(c(e,p),b(null),w(""))}catch(p){console.error("Error updating comment:",p),P.error("Failed to update comment. Please try again.")}},O=f=>{try{if(!f)return"Just now";if(f&&typeof f=="object"&&f.seconds)return ke(new Date(f.seconds*1e3),{addSuffix:!0});const p=new Date(f);return isNaN(p.getTime())?"Just now":ke(p,{addSuffix:!0})}catch(p){return console.error("Error formatting date:",p),"Just now"}},C=(f=>{const p={};return f.forEach(u=>{const S=u.parentCommentId||"root";p[S]||(p[S]=[]),p[S].push(u)}),p})(t),F=C.root||[],H=(f,p=0)=>f.slice(0,v).map(u=>a.jsxs("div",{className:`comment-container ${m?"dark-mode":""}`,style:{marginLeft:p*20},children:[a.jsxs("div",{children:[a.jsx("span",{className:"comment-username",children:u.username||"Anonymous"}),a.jsx("span",{className:"comment-time",children:O(u.createdAt)}),_===u.id?a.jsxs(a.Fragment,{children:[a.jsx("textarea",{value:T,onChange:S=>w(S.target.value),className:"comment-input"}),a.jsxs("div",{className:"mt-2 space-x-2",children:[a.jsx("button",{className:"reply-btn",onClick:()=>R(u.id),children:"Save"}),a.jsx("button",{className:"cancel-btn",onClick:()=>{b(null),w("")},children:"Cancel"})]})]}):a.jsx("span",{className:"comment-text",dangerouslySetInnerHTML:{__html:G.sanitize(u.text)}})]}),a.jsxs("div",{className:"comment-actions",children:[a.jsxs("button",{onClick:()=>N(u),className:`flex items-center space-x-2 px-3 py-1 rounded-full transition-all duration-200 ${n&&u.likes&&Array.isArray(u.likes)&&u.likes.includes(n.uid)?m?"bg-red-900 bg-opacity-30 text-red-400 hover:bg-red-800 hover:bg-opacity-40":"bg-red-50 text-red-500 hover:bg-red-100":m?"bg-gray-700 text-gray-300 hover:bg-gray-600":"bg-gray-100 text-gray-600 hover:bg-gray-200"} ${i.has(u.id)?"opacity-60 cursor-not-allowed":""}`,disabled:!n||i.has(u.id),title:n?void 0:"Sign in to like comments","aria-busy":i.has(u.id),"aria-label":n&&u.likes&&Array.isArray(u.likes)&&u.likes.includes(n.uid)?"Unlike this comment":"Like this comment",children:[n&&u.likes&&Array.isArray(u.likes)&&u.likes.includes(n.uid)?a.jsx(Fe,{className:`w-4 h-4 text-red-500 ${i.has(u.id)?"animate-pulse":""}`}):a.jsx(We,{className:`w-4 h-4 ${i.has(u.id)?"animate-pulse":""}`}),a.jsx("span",{className:`font-medium ${n&&u.likes&&Array.isArray(u.likes)&&u.likes.includes(n.uid)?m?"text-red-400":"text-red-500":m?"text-gray-300":"text-gray-600"}`,children:Array.isArray(u.likes)?u.likes.length:0})]}),a.jsx("button",{onClick:()=>g(u.id),className:`reply-button ${m?"text-blue-400 hover:text-blue-300":"hover:text-blue-600"}`,disabled:!n,title:n?void 0:"Sign in to reply to comments",children:"Reply"}),n&&(n.uid===u.userId||n.role==="admin")&&a.jsxs(a.Fragment,{children:[a.jsx("button",{onClick:()=>{b(u.id),w(u.text)},className:`edit-button ${m?"text-blue-400 hover:text-blue-300":"hover:text-blue-600"}`,children:"Edit"}),a.jsx("button",{onClick:()=>D(u.id),className:`delete-button ${m?"text-red-400 hover:text-red-300":"hover:text-red-600"}`,children:"Delete"})]})]}),j===u.id&&a.jsxs("div",{className:"reply-section",style:{marginLeft:20,marginTop:"4px"},children:[a.jsx("input",{type:"text",className:"comment-input",placeholder:"Write a reply...",value:k,onChange:S=>M(S.target.value)}),a.jsx("button",{className:"reply-btn",onClick:()=>W(u.id),children:"Submit Reply"}),a.jsx("button",{className:"cancel-btn",onClick:()=>{g(null),M("")},children:"Cancel"})]}),C[u.id]&&H(C[u.id],p+1)]},u.id));return a.jsxs("div",{className:`space-y-4 ${m?"comments-dark":"comments-light"}`,children:[L&&a.jsx("p",{className:"text-red-500",children:L}),H(F),F.length>v&&a.jsx("button",{className:"load-more-btn",onClick:()=>x(f=>f+4),children:"Load More Comments"})]})},pn=({postId:e})=>{const{user:t}=d.useContext(J),{fetchBatchComments:r,addCommentToCache:s,commentsCache:n}=d.useContext(V),{darkMode:c}=me(),[l,o]=d.useState([]),[m,i]=d.useState(!0),[h,v]=d.useState(""),[x,j]=d.useState(""),g=d.useRef(!1),k=d.useRef(!0),M=b=>t?!0:(P.info(a.jsxs("div",{children:["Please ",a.jsx("a",{href:"/signin",className:"text-blue-500 hover:text-blue-700",children:"sign in"})," or"," ",a.jsx("a",{href:"/signup",className:"text-blue-500 hover:text-blue-700",children:"sign up"})," to ",b,"."]}),{position:"top-center",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0}),!1);d.useEffect(()=>{k.current=!0;let b=null;return(async()=>{if(!e){i(!1);return}if(!g.current)try{if(i(!0),n[e]&&Array.isArray(n[e])){o(n[e]);const w=localStorage.getItem(`commentsLastFetch_${e}`);w&&Date.now()-parseInt(w)<3e4&&i(!1)}b=setTimeout(()=>{k.current&&m&&(i(!1),v("Comments are taking longer than expected to load. Please try refreshing."))},1e4);try{const w=await r([e],!1);if(!k.current)return;w&&w[e]?(o(w[e]),localStorage.setItem(`commentsLastFetch_${e}`,Date.now().toString()),v("")):(!n[e]||!Array.isArray(n[e]))&&o([])}catch(w){console.error(`[CommentsSection] Error fetching fresh comments for post ${e}:`,w),n[e]&&Array.isArray(n[e])?P.warn("Using cached comments - unable to refresh from the server."):v("Unable to load comments. Please try again later.")}}catch(w){k.current&&(v("Failed to load comments. Please try again later."),console.error(`[CommentsSection] Error loading comments for post ${e}:`,w))}finally{k.current&&(i(!1),b&&clearTimeout(b),g.current=!0)}})(),()=>{k.current=!1,b&&clearTimeout(b)}},[e,r,n]),d.useEffect(()=>{n[e]&&Array.isArray(n[e])&&o(n[e])},[n,e]);const _=async()=>{if(x.trim()&&M("add a comment"))try{const b=await $e(e,{commentText:x.trim()}),T=b?.comment||b;T?(o(w=>[T,...w]),s(e,T),j(""),v("")):(console.error("Invalid comment data in response:",b),P.error("Failed to add comment. Invalid response from server."))}catch(b){console.error("Error adding comment:",b),v("Failed to add comment. Please try again."),P.error("Failed to add comment. Please try again.")}};return a.jsxs("div",{className:`mt-6 ${c?"comments-section-dark":"comments-section-light"}`,children:[a.jsxs("h2",{className:`text-xl font-semibold mb-2 ${c?"text-gray-200":"text-gray-800"}`,children:["Comments (",l?.length||0,")"]}),a.jsxs("div",{className:"mb-4",children:[a.jsx("textarea",{value:x,onChange:b=>j(b.target.value),className:`w-full p-2 border rounded resize-none transition-colors ${t?c?"bg-gray-700 text-white border-gray-600 hover:border-blue-400 focus:border-blue-400 focus:ring-1 focus:ring-blue-400":"bg-white hover:border-blue-500 focus:border-blue-500 focus:ring-1 focus:ring-blue-500":c?"bg-gray-800 text-gray-400":"bg-gray-100"}`,placeholder:t?"Write a comment...":"Sign in to comment",disabled:!t,rows:"3"}),a.jsxs("div",{className:"mt-2 flex justify-between items-center",children:[a.jsx("button",{onClick:_,className:`px-4 py-2 rounded transition-colors ${t&&x.trim()?c?"bg-indigo-600 text-white hover:bg-indigo-700":"bg-blue-600 text-white hover:bg-blue-700":c?"bg-gray-700 text-gray-400 cursor-not-allowed":"bg-gray-300 text-gray-600 cursor-not-allowed"}`,disabled:!t||!x.trim(),children:t?"Add Comment":"Sign in to Comment"}),h&&a.jsx("p",{className:"text-red-500",children:h})]})]}),m?a.jsx("div",{className:"flex justify-center items-center py-4",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500"})}):l.length===0?a.jsxs("p",{className:`text-center py-4 ${c?"text-gray-400":"text-gray-600"}`,children:["No comments yet. ",t?"Be the first to comment!":"Sign in to be the first to comment!"]}):a.jsx(xn,{postId:e,comments:l,onAuthRequired:M})]})},vn=({postId:e,initialLikes:t=[],className:r=""})=>{const[s,n]=d.useState(t?t.length:0),[c,l]=d.useState(!1),[o,m]=d.useState(!1),{user:i}=d.useContext(J),{postDetails:h,updatePostInCache:v}=d.useContext(V),x=d.useRef(0),j=d.useRef(!0),g=d.useRef(0);d.useEffect(()=>{if(j.current=!0,!!e){if(h&&h[e]){const b=h[e].likes||[];n(b.length),l(i?.uid?b.includes(i.uid):!1)}else t&&(n(t.length),l(i?.uid?t.includes(i.uid):!1));return()=>{j.current=!1}}},[e,i?.uid,h,t]);const k=d.useCallback(Ie(async(_,b,T)=>{if(!j.current||T!==g.current)return;if(!e){console.error("[LikeButton] Missing postId for like action"),b(),j.current&&m(!1);return}const L=Date.now()-x.current,E=1e3;if(L<E){const A=E-L;if(await new Promise(N=>setTimeout(N,A)),!j.current||T!==g.current)return}x.current=Date.now();try{const A=c?"unlike":"like",N=await ye(e);if(!j.current||T!==g.current)return;if(N&&N.updatedPost){const W=N.updatedPost.likes||[];n(W.length),l(i?.uid?W.includes(i?.uid):!1),v(N.updatedPost)}else console.warn(`[LikeButton] Unexpected response format for post ${e}:`,N),b(),P.error("Server returned an unexpected response. Please try again.")}catch(A){console.error(`[LikeButton] Error toggling like for post ${e}:`,A),b(),A.message?P.error(`Failed to update like: ${A.message}`):P.error("Failed to update like. Please try again.")}finally{j.current&&T===g.current&&m(!1)}},300),[e,i?.uid,c,v,ye]),M=async()=>{if(!i){P.info(a.jsxs("div",{children:["Please ",a.jsx(qe,{to:"/sign-in",className:"text-blue-500 hover:text-blue-700",children:"sign in"})," to like posts"]}),{position:"top-center",autoClose:5e3,hideProgressBar:!1,closeOnClick:!0,pauseOnHover:!0,draggable:!0});return}if(o)return;m(!0);const _=c,b=s,T=Date.now();g.current=T;const w=()=>{l(!c),n(E=>c?E-1:E+1)},L=()=>{l(_),n(b)};w(),k(w,L,T)};return a.jsxs("button",{onClick:M,disabled:o,className:`flex items-center space-x-2 px-4 py-2 rounded-full transition-all duration-200 ${c?"bg-red-50 text-red-500 hover:bg-red-100":"bg-gray-100 text-gray-600 hover:bg-gray-200"} ${r} ${o?"opacity-60 cursor-not-allowed":""}`,"aria-busy":o,"aria-label":c?"Unlike this post":"Like this post",children:[c?a.jsx(Fe,{className:`w-5 h-5 text-red-500 ${o?"animate-pulse":""}`}):a.jsx(We,{className:`w-5 h-5 ${o?"animate-pulse":""}`}),a.jsx("span",{className:`font-medium ${c?"text-red-500":"text-gray-600"}`,children:s})]})};He.extend({content:"inline*"});const wn=[st.configure({bulletList:{keepMarks:!0,keepAttributes:!1},orderedList:{keepMarks:!0,keepAttributes:!1}}),it.configure({HTMLAttributes:{class:"custom-task-list"}}),He.configure({nested:!0}),ot.configure({types:[xe.name,ft.name]}),xe,ct.configure({types:["heading","paragraph","image"],alignments:["left","center","right","justify"],defaultAlignment:"left"}),lt.configure({HTMLAttributes:{class:"aligned-image"},resizable:!0,inline:!0,addAttributes(){return{style:{default:null,renderHTML:e=>({style:e.style}),parseHTML:e=>e.getAttribute("style")},"data-align":{default:"none",renderHTML:e=>({"data-align":e["data-align"]}),parseHTML:e=>e.getAttribute("data-align")}}}}),ut.configure({persistedAttributes:["width","height","style"],keepStyles:!0}),dt.configure({controls:!1,nocookie:!0})],kn=({content:e,onUpdate:t})=>a.jsx(at,{extensions:wn,content:e,editable:!0,onUpdate:r=>{const s=r.editor.getHTML(),n=G.sanitize(s,{ADD_ATTR:["style","data-align","width","height","class"],ADD_TAGS:["iframe"],ALLOWED_TAGS:["p","strong","em","img","a","ul","ol","li","h1","h2","h3","h4","h5","blockquote","iframe"],ALLOWED_ATTR:["href","src","style","class","data-align","width","height"]});t(n)},children:a.jsxs("div",{className:"my-tiptap-editor",children:[a.jsx(mt,{}),a.jsx("div",{className:"ProseMirror"})]})}),Sn=()=>{const{postId:e}=Qe();Ke();const{user:t,token:r}=d.useContext(J),{darkMode:s}=me(),n=t?.role==="admin",{getPostById:c,updatePostInCache:l,getComments:o,postDetails:m}=d.useContext(V),[i,h]=d.useState(null),[v,x]=d.useState(!0),[j,g]=d.useState(!1),[k,M]=d.useState(""),[_,b]=d.useState(""),[T,w]=d.useState(""),L=d.useRef(null),E=d.useRef(!1),A=d.useRef(!1);d.useEffect(()=>{if(e==="create")return;const D=()=>{L.current&&(L.current(),L.current=null)};E.current=!1,A.current=!1,D();const R=async()=>{v===!1&&x(!0);try{const y=await c(e);y&&(h(y),w(y.additionalHTML||""),A.current=!0)}catch(y){console.error("Error loading post:",y),M(y.message)}finally{x(!1)}},O=()=>{L.current=et(tt(nt,"posts",e),y=>{if(y.exists()){const C=y.data();h(F=>F?{...F,likes:C.likes||[],views:C.views||0}:{id:e,...C})}},y=>{console.error("Firebase listener error:",y)})};return R(),O(),D},[e]),d.useEffect(()=>{if(!(!i||e==="create"||!A.current)&&!E.current)return E.current=!0,Ze(e).then(D=>{D.success===!1&&console.warn(`[PostDetail] View increment failed: ${D.error}`),setTimeout(()=>{c(e,!0).then(R=>{R&&(h(O=>({...O,views:R.views||0})),l&&l(R))}).catch(R=>{console.error("[PostDetail] Error refreshing post data:",R)})},500)}).catch(D=>{console.error("[PostDetail] Error incrementing view count:",D),c(e,!0).catch(()=>{})}),()=>{E.current=!1}},[e]);const N=async D=>{if(D.preventDefault(),!n||!i)return;const O={additionalHTML:G.sanitize(T,{ADD_ATTR:["style","data-align","width","height","class"],ADD_TAGS:["iframe"],ALLOWED_TAGS:["p","strong","em","img","a","ul","ol","li","h1","h2","h3","h4","h5","blockquote","iframe"],ALLOWED_ATTR:["href","src","style","class","data-align","width","height"]})};try{const y=await rt(e,O,r);if(y.message){const C=await c(e,!0);l(C),await o(e,!0),h(C),w(C.additionalHTML||""),g(!1),b("Post updated successfully!"),setTimeout(()=>b(""),3e3)}else M(y.error||"Failed to update post.")}catch(y){console.error("Error saving post:",y),M("An unexpected error occurred while saving the post.")}};if(v)return a.jsx("div",{className:`text-center mt-10 ${s?"text-gray-300":"text-gray-700"}`,children:"Loading post..."});if(k)return a.jsx("div",{className:`text-center mt-10 ${s?"text-red-400":"text-red-500"}`,children:k});if(!i)return a.jsx("div",{className:`text-center mt-10 ${s?"text-gray-300":"text-gray-700"}`,children:"No post data found."});const W=D=>D?new Date(D).toLocaleString():"N/A";return a.jsxs("div",{className:`post-detail-container max-w-5xl mx-auto p-6 ${s?"theme-dark":"theme-light"}`,children:[_&&a.jsx("p",{className:"text-green-600 text-center font-semibold mb-4",children:_}),a.jsx(qe,{to:"/latest-tech",className:"inline-block mb-4 text-blue-600 hover:text-blue-800",children:"â† Back to Posts"}),j?a.jsxs("form",{onSubmit:N,className:"space-y-4",children:[a.jsx("h2",{className:"text-2xl font-semibold mb-4",children:"Edit Post"}),a.jsxs("div",{className:"mb-4",children:[a.jsx("label",{className:"block text-gray-700 mb-2",children:"Content"}),a.jsx(kn,{content:T,onUpdate:D=>w(D)})]}),k&&a.jsx("p",{className:"text-red-500",children:k}),a.jsxs("div",{className:"flex space-x-2",children:[a.jsx("button",{type:"submit",className:"px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700",children:"Save Changes"}),a.jsx("button",{type:"button",onClick:()=>{g(!1),M(""),w(i.additionalHTML||"")},className:"px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400",children:"Cancel"})]})]}):a.jsxs("div",{children:[n&&a.jsx("div",{className:"mb-4 flex justify-end",children:a.jsx("button",{onClick:()=>g(!0),className:"px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700",children:"Edit Post"})}),a.jsx("h2",{className:"text-3xl font-bold mb-4",children:i.title}),a.jsxs("div",{className:"flex items-center space-x-4 mb-4",children:[a.jsx(vn,{postId:e,initialLikes:i.likes||[]}),a.jsxs("span",{className:`${s?"text-gray-300":"text-gray-600"}`,children:[i.views||0," views"]})]}),i.additionalHTML&&a.jsx("div",{className:"prose max-w-none mb-4",dangerouslySetInnerHTML:{__html:G.sanitize(i.additionalHTML)}}),a.jsxs("p",{className:`text-sm ${s?"text-gray-300":"text-gray-500"}`,children:["Created At: ",W(i.createdAt)]}),a.jsxs("p",{className:`text-sm ${s?"text-gray-300":"text-gray-500"}`,children:["Created By: ",i.createdByUsername||"Unknown"]}),a.jsx(pn,{postId:e})]})]})};export{Sn as default};
