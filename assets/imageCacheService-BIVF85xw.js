var g={};const c=new Map,i=()=>{let t=0;try{for(let a=0;a<localStorage.length;a++){const r=localStorage.key(a);if(r&&r.startsWith("img_")){const e=localStorage.getItem(r);e&&(t+=e.length)}}}catch(a){console.warn("Error calculating cache size:",a)}return t},m=()=>{const t=Date.now(),r=Object.keys(localStorage).filter(e=>e.startsWith("img_")).map(e=>{try{const o=JSON.parse(localStorage.getItem(e));return{key:e,timestamp:o.timestamp||0,size:o.size||0}}catch{return{key:e,timestamp:0,size:0}}}).sort((e,o)=>o.timestamp-e.timestamp);if(r.slice(200).forEach(({key:e})=>{localStorage.removeItem(e)}),r.forEach(({key:e,timestamp:o})=>{t-o>864e5&&localStorage.removeItem(e)}),i()>10485760){const o=Object.keys(localStorage).filter(s=>s.startsWith("img_")).map(s=>{try{const n=JSON.parse(localStorage.getItem(s));return{key:s,size:n.size||0}}catch{return{key:s,size:0}}}).sort((s,n)=>n.size-s.size);for(const{key:s}of o)if(localStorage.removeItem(s),i()<=10485760)break}},h=(t,a,r=0)=>{try{i()>10485760&&m();const e={value:a,size:r,timestamp:Date.now()};return localStorage.setItem(t,JSON.stringify(e)),!0}catch(e){return console.warn("Image cache storage failed:",e),e.name==="QuotaExceededError"&&Object.keys(localStorage).forEach(o=>{o.startsWith("img_")&&localStorage.removeItem(o)}),!1}},f=t=>{try{const a=localStorage.getItem(t);if(!a)return null;const r=JSON.parse(a);return Date.now()-r.timestamp>864e5?(localStorage.removeItem(t),null):r.value}catch(a){return console.warn("Image cache retrieval failed:",a),null}},S=t=>{const a=t.split("").reduce((r,e)=>(r=(r<<5)-r+e.charCodeAt(0),r&r),0);return`img_${Math.abs(a)}`},C=t=>new Promise((a,r)=>{const e=new Image;e.crossOrigin="anonymous",e.onload=()=>{try{const o=document.createElement("canvas"),s=o.getContext("2d");o.width=e.width,o.height=e.height,s.drawImage(e,0,0);const n=o.toDataURL("image/jpeg",.8),l=n.length*.75;if(l>512e3){console.warn(`Image too large (${Math.round(l/1024)}KB), skipping cache`),a(null);return}a({base64:n,size:l})}catch(o){console.warn("Error converting image to base64:",o),a(null)}},e.onerror=()=>{console.warn("Error loading image for cache:",t),a(null)},e.src=t}),I=async t=>{if(!t||typeof t!="string")return null;if(t.includes("firebasestorage.googleapis.com")||t.includes("storage.googleapis.com"))return t;if(c.has(t)){const e=c.get(t);if(e.timestamp>Date.now()-864e5)return e.base64;c.delete(t)}const a=S(t),r=f(a);if(r)return c.set(t,{base64:r,timestamp:Date.now()}),r;try{const e=await C(t);if(e){const{base64:o,size:s}=e;return h(a,o,s),c.set(t,{base64:o,timestamp:Date.now()}),o}}catch{}return null},p=async t=>{if(!t||!Array.isArray(t))return;const a=t.map(e=>e.image).filter(e=>e&&typeof e=="string"&&!e.startsWith("data:")).filter(e=>e.includes("firebasestorage.googleapis.com")||e.includes("storage.googleapis.com")?!1:!c.has(e)||c.get(e).timestamp<=Date.now()-864e5).slice(0,10);if(a.length===0)return;try{const e=g.REACT_APP_API_URL||"http://localhost:4000",o=await fetch(`${e}/api/cache/images/preload`,{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("token")}`},body:JSON.stringify({imageUrls:a})});if(o.ok){const s=await o.json()}}catch{}const r=a.map(async e=>{try{await I(e)}catch{}});await Promise.allSettled(r)},d=()=>{try{c.clear(),Object.keys(localStorage).forEach(t=>{t.startsWith("img_")&&localStorage.removeItem(t)})}catch(t){console.error("Error clearing image cache:",t)}},E=()=>{const t=Object.keys(localStorage).filter(e=>e.startsWith("img_")),a=i(),r=c.size;return{totalImages:t.length,totalSize:a,memoryCacheSize:r,maxSize:10485760,maxItems:200}},_=()=>{m()};export{_ as cleanupExpiredCache,d as clearImageCache,E as getCacheStats,I as getCachedImage,p as preloadImages};
