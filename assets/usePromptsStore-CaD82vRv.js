import{a8 as y}from"./index-CDuOHj3I.js";import{g as P,a as C}from"./promptsApi-BDedM9HX.js";const f="prompts_cache",h="prompts_cache_timestamp",D=1800*1e3,g=600*1e3,b=y((a,r)=>({prompts:[],isLoaded:!1,isLoading:!1,error:null,unsubscribe:null,lastRefreshed:null,currentPage:1,totalPages:1,totalCount:0,pageSize:20,hasMore:!1,searchQuery:"",filters:{category:"All",tags:null,featured:null,createdBy:null},categories:[],startListening:()=>{if(!r().unsubscribe)try{const e=r().loadFromCache();if(e&&e.prompts&&e.prompts.length>0){const t=!r().isCacheExpired(e.timestamp);a({prompts:e.prompts,totalCount:e.totalCount||e.prompts.length,isLoaded:!0,isLoading:!1,lastRefreshed:e.timestamp}),t||r().fetchPrompts(!0,!1)}else r().fetchPrompts(!1,!0);const o=setInterval(()=>{if(document.visibilityState==="visible"){const{lastRefreshed:t}=r();(t?Date.now()-t:1/0)>g&&r().fetchPrompts(!0,!1)}},g);a({unsubscribe:()=>clearInterval(o)}),r().fetchCategories()}catch(e){console.error("Error setting up prompts polling:",e),a({error:e.message||"Failed to set up prompts polling",isLoading:!1}),r().fetchPrompts(!1,!0)}},stopListening:()=>{const e=r().unsubscribe;e&&(e(),a({unsubscribe:null}))},fetchPrompts:async(e=!1,o=!0)=>{const{searchQuery:t,filters:s,currentPage:n,pageSize:l,isLoaded:c,lastRefreshed:d,prompts:m}=r();if(!e&&c&&d&&Date.now()-d<3e5&&m.length>0)return m;o&&a({isLoading:!0,error:null});try{if(!e){const u=r().loadFromCache();if(u&&!r().isCacheExpired(u.timestamp))return a({prompts:u.prompts,totalCount:u.totalCount||u.prompts.length,isLoaded:!0,isLoading:!1,lastRefreshed:u.timestamp}),u.prompts}const p={searchQuery:t||void 0,category:s.category!=="All"?s.category:void 0,tags:s.tags||void 0,featured:s.featured||void 0,createdBy:s.createdBy||void 0,limit:l,offset:(n-1)*l},i=await C(p);return a({prompts:i.prompts,totalCount:i.totalCount,currentPage:i.currentPage,totalPages:i.totalPages,hasMore:i.hasMore,isLoaded:!0,isLoading:!1,lastRefreshed:Date.now(),error:null}),r().saveToCache(i.prompts,i.totalCount),i.prompts}catch(p){return console.error("Error fetching prompts:",p),a({error:p.message||"Failed to load prompts",isLoading:!1}),[]}},fetchCategories:async()=>{try{const e=await P();a({categories:e})}catch(e){console.error("Error fetching prompt categories:",e)}},setSearchQuery:async e=>{a({searchQuery:e,currentPage:1}),await r().fetchPrompts(!0,!0)},setFilters:async e=>{a({filters:{...r().filters,...e},currentPage:1}),await r().fetchPrompts(!0,!0)},setPage:async e=>{const{totalPages:o}=r();e<1||e>o||(a({currentPage:e}),await r().fetchPrompts(!0,!0))},setPageSize:async e=>{e<4||e>100||(a({pageSize:e,currentPage:1}),await r().fetchPrompts(!0,!0))},saveToCache:(e,o)=>{try{if(!e||e.length===0)return;const t=Date.now(),s={prompts:e,totalCount:o||e.length,timestamp:t},n=r().loadFromCache();if(n&&n.prompts&&n.prompts.length===e.length&&t-n.timestamp<300*1e3)return;localStorage.setItem(f,JSON.stringify(s)),localStorage.setItem(h,t.toString()),r().saveToIndexedDB(e)}catch(t){console.error("Error saving prompts to cache:",t)}},saveToIndexedDB:e=>{try{if(!window.indexedDB)return;const o=window.indexedDB.open("AIWaveriderOfflineDB",1);o.onupgradeneeded=t=>{const s=t.target.result;if(!s.objectStoreNames.contains("prompts")){const n=s.createObjectStore("prompts",{keyPath:"id"});n.createIndex("createdAt","createdAt",{unique:!1}),n.createIndex("category","category",{unique:!1})}},o.onsuccess=t=>{const n=t.target.result.transaction(["prompts"],"readwrite"),l=n.objectStore("prompts");l.clear(),e.forEach(c=>{l.add(c)}),n.oncomplete=()=>{},n.onerror=c=>{console.error("IndexedDB transaction error:",c)}},o.onerror=t=>{console.error("Error opening IndexedDB:",t)}}catch(o){console.error("Error saving to IndexedDB:",o)}},loadFromIndexedDB:()=>new Promise(e=>{try{if(!window.indexedDB){e(null);return}const o=window.indexedDB.open("AIWaveriderOfflineDB",1);o.onsuccess=t=>{const s=t.target.result;if(!s.objectStoreNames.contains("prompts")){e(null);return}const c=s.transaction(["prompts"],"readonly").objectStore("prompts").getAll();c.onsuccess=()=>{const d=c.result;d&&d.length>0?e(d):e(null)},c.onerror=()=>{e(null)}},o.onerror=()=>{e(null)}}catch(o){console.error("Error in loadFromIndexedDB:",o),e(null)}}),loadFromCache:()=>{try{const e=localStorage.getItem(f);return e?JSON.parse(e):null}catch(e){return console.error("Error loading prompts from cache:",e),null}},isCacheExpired:e=>e?Date.now()-e>D:!0,clearCache:()=>{try{localStorage.removeItem(f),localStorage.removeItem(h)}catch(e){console.error("Error clearing prompts cache:",e)}},forceRefresh:async()=>{r().clearCache(),a({isLoading:!0,currentPage:1}),await r().fetchPrompts(!0,!0),await r().fetchCategories()},resetFilters:async()=>{a({searchQuery:"",filters:{category:"All",tags:null,createdBy:null},currentPage:1}),await r().fetchPrompts(!0,!0)}}));export{b as u};
